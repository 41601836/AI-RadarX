# Java 接口压测指南

## 1. 概述

本指南提供了使用 `java-api-benchmark.js` 脚本对 Java 后端 API 进行性能压测的详细说明。该脚本使用 Node.js 和 Axios 库实现，可以模拟多个并发用户对 API 接口进行请求，并收集关键性能指标。

## 2. 压测脚本功能

### 2.1 核心功能
- **多接口测试**：支持同时测试多个 Java 后端 API 接口
- **并发模拟**：可配置的并发用户数和请求数
- **性能指标收集**：
  - 总请求数和成功率
  - 错误率
  - 响应时间统计（平均、最小、最大、P50、P90、P95、P99）
  - 最大并发请求数
  - 吞吐量（请求/秒）
- **实时监控**：测试过程中实时显示性能指标
- **测试报告**：详细的测试结果报告和数据文件

### 2.2 测试的 API 接口

默认配置测试以下接口：

| 接口名称 | 路径 | 方法 | 参数 |
|---------|------|------|------|
| 获取K线数据 | /market/kline | GET | symbol: SH600000, interval: 1d, limit: 100 |
| 获取股票基本信息 | /market/stock_basic | GET | exchange: SSE,SZSE, list_status: L |
| 获取实时行情 | /market/quote | GET | symbols: SH600000,SZ000001 |
| 获取筹码分布 | /chip/distribution | GET | stockCode: SH600000, days: 30 |
| 获取技术指标 | /tech/indicator/data | GET | stockCode: SH600000, indicators: ma,macd,rsi |

## 3. 环境准备

### 3.1 系统要求
- Node.js 14.x 或更高版本
- npm 或 yarn 包管理器

### 3.2 依赖安装

在项目根目录执行以下命令安装依赖：

```bash
npm install axios
```

## 4. 运行压测

### 4.1 配置压测参数

在 `java-api-benchmark.js` 文件中，可以根据需要修改以下配置参数：

```javascript
const config = {
  // Java 后端基础 URL
  baseUrl: 'http://localhost:8080/api/v1',
  
  // 压测参数
  concurrentUsers: 50,      // 并发用户数
  requestPerUser: 10,       // 每个用户发送的请求数
  testDuration: 60,         // 测试持续时间（秒）
  rampUpTime: 10,           // 预热时间（秒）
  
  // 输出配置
  outputFile: 'java-api-benchmark-results.json',
  printInterval: 5          // 打印间隔（秒）
};
```

### 4.2 启动压测

确保 Java 后端服务正在运行，然后执行以下命令启动压测：

```bash
node java-api-benchmark.js
```

### 4.3 压测过程

压测过程中，脚本会实时显示以下信息：
- 已执行请求数
- 成功请求数
- 错误率
- 平均响应时间
- 最大并发请求数
- 吞吐量

## 5. 测试结果分析

### 5.1 测试报告

压测完成后，脚本会生成详细的测试报告，包括：

- **基本信息**：测试时间、持续时间、总请求数等
- **性能指标**：响应时间统计、错误率、吞吐量等
- **接口性能详情**：每个接口的请求数、成功率和平均响应时间

### 5.2 测试数据文件

测试结果会保存到 `java-api-benchmark-results.json` 文件中，包含：

- 配置参数
- 详细的请求记录
- 错误信息
- 性能指标

### 5.3 关键指标说明

| 指标 | 说明 |
|------|------|
| 错误率 | 错误请求数占总请求数的百分比，理想值应低于 1% |
| 平均响应时间 | 所有成功请求的平均响应时间，反映系统的平均性能 |
| P50 | 50% 的请求响应时间小于此值，反映系统的典型性能 |
| P90 | 90% 的请求响应时间小于此值，反映系统的大多数性能 |
| P95 | 95% 的请求响应时间小于此值，反映系统的高性能要求 |
| P99 | 99% 的请求响应时间小于此值，反映系统的极端性能要求 |
| 吞吐量 | 单位时间内处理的请求数，反映系统的处理能力 |

## 6. 优化建议

根据测试结果，可以采取以下优化措施：

### 6.1 性能瓶颈分析
- 如果平均响应时间过高，检查 API 内部逻辑是否存在性能瓶颈
- 如果 P99 响应时间过高，检查是否存在资源争用或锁竞争
- 如果错误率过高，检查 API 稳定性和错误处理机制

### 6.2 优化方向
- **API 优化**：优化算法、减少数据库查询、增加缓存
- **系统优化**：调整 JVM 参数、增加服务器资源、优化数据库配置
- **架构优化**：增加负载均衡、实现服务降级、优化网络通信

## 7. 扩展压测

### 7.1 添加新接口测试

在 `config.endpoints` 数组中添加新的接口配置：

```javascript
{
  name: '接口名称',
  path: '/api/path',
  method: 'GET',
  params: { param1: 'value1', param2: 'value2' },
  body: null
}
```

### 7.2 调整压测策略

根据实际需求调整压测参数：
- 增加 `concurrentUsers` 测试系统的并发处理能力
- 增加 `testDuration` 测试系统的稳定性
- 调整 `rampUpTime` 模拟真实的用户流量增长

## 8. 注意事项

1. **测试环境**：建议在与生产环境相似的测试环境中进行压测
2. **数据一致性**：确保测试数据在多次压测中保持一致
3. **资源监控**：在压测过程中监控服务器的 CPU、内存、磁盘和网络使用情况
4. **逐步加压**：从低并发开始，逐步增加并发用户数，观察系统性能变化
5. **结果解读**：结合系统资源监控和压测结果综合分析性能瓶颈

## 9. 联系方式

如有任何问题或建议，请联系技术团队。
